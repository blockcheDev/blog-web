worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # 获取真实客户端IP
    set_real_ip_from 0.0.0.0/0;
    real_ip_header  X-Forwarded-For;
    real_ip_recursive on;

    # Gzip 压缩配置
    gzip on;
    gzip_static on;
    gzip_vary on;

    # hitori.cn HTTP -> anonchan.cc HTTPS 重定向
    server {
        listen       80;
        server_name  hitori.cn www.hitori.cn;
        return 301 https://anonchan.cc$request_uri;
    }

    # hitori.cn HTTPS -> anonchan.cc HTTPS 重定向
    server {
        listen       443 ssl;
        server_name  hitori.cn www.hitori.cn;

        ssl_certificate      /usr/local/nginx/conf/cert/anonchan.cc_bundle.crt;
        ssl_certificate_key  /usr/local/nginx/conf/cert/anonchan.cc.key;
        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;
        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;

        return 301 https://anonchan.cc$request_uri;
    }

    # anonchan.cc HTTP -> HTTPS 重定向
    server {
        listen       80;
        server_name  anonchan.cc www.anonchan.cc;
        return 301 https://$host$request_uri;
    }

    # anonchan.cc HTTPS 主站
    server {
        listen       443 ssl;
        server_name  anonchan.cc www.anonchan.cc;

        ssl_certificate      /usr/local/nginx/conf/cert/anonchan.cc_bundle.crt;
        ssl_certificate_key  /usr/local/nginx/conf/cert/anonchan.cc.key;
        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;
        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;

        # API 反向代理
        location /api {
            proxy_pass http://172.17.0.1:8080/api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 前端静态文件
        location / {
            root   /usr/local/dist;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }

        # Sitemap
        location /sitemap.xml {
            alias /sitemap-generator/sitemap.xml;
        }
    }
}
